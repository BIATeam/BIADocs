---
layout: default
title: V3.8.0 to V3.9.0
parent: Migrate an existing project
nav_order: 32
---
# Framework from v3.8.0 to v3.9.0

## AUTOMATIC MIGRATION
 
1. Update Visual Studio to the latest version ((Migration tested with Visual Studio 2022 version 17.10.3))
2. Use the BIAToolKit to migrate the project

3. Manage the confict (2 solutions)
   1. In BIAToolKit click on "4 - merge Rejected" and search "<<<<<" in all files.  
    * Resolve the conflit manualy.
   2. Analyse the .rej file (search "diff a/" in VS code) that have been created in your project folder
     * Apply manualy the change.

4. Change source path and run the script [V3.8.0_to_V3.9.0_Replacement.ps1](./Scripts/V3.8.0_to_V3.9.0_Replacement.ps1)

5. Apply other manual step (describe bellow) at the end if all is ok, you can remove the .rej files (durring the process they can be usefull to resolve build probleme)

## MANUAL STEPS
### FRONT
1. If you don't use the Offline mode, disable the serviceWorker in the angular.json file : ```"serviceWorker": false```
   
2. Add selector on all component.
   
a. search in the Angular folder
```typescript
@Component({
  templateUrl:
```
b. add the selector (like on index file for item: just replace index by item) ex for plane item:
```typescript
@Component({
  selector: 'app-planes-item',
  templateUrl: ...
```

### BACK
1. The migration script removes **catch** in controllers. Delete the **try** in error which no longer has a **catch**.
2. Mapper injectable: UserContext should be injected (and no more pass from service)
If you have mapper that need UserContext you have to injected it in the constructor (ex from RoleOptionMapper):
  ```csharp
          /// <summary>
        /// Initializes a new instance of the <see cref="RoleOptionMapper"/> class.
        /// </summary>
        /// <param name="userContext">the user context</param>
        public RoleOptionMapper(UserContext userContext)
        {
            this.UserContext = userContext;
        }

        /// <summary>
        /// The user context langage and culture.
        /// </summary>
        private UserContext UserContext { get; set; }
  ```
And you can remove it from the service that use it:
  ```csharp
        /// <summary>
        /// Initializes a new instance of the <see cref="RoleAppService"/> class.
        /// </summary>
        /// <param name="repository">The repository.</param>
        /// <param name="userContext">The user context.</param>
--        public RoleAppService(ITGenericRepository<Role, int> repository, UserContext userContext)
++        public RoleAppService(ITGenericRepository<Role, int> repository)
            : base(repository)
        {
--            this.userContext = userContext;
        }
  ```

3. Search LastName in all mapper in EntityToDto function
use user.Display() instead of 
user.LastName + " " + user.FirstName + " (" + user.Login + ")"
And user.DisplayShort() instead of 
user.LastName + " " + user.FirstName

4. HandlerRepository change Constructor base parameter:
For classes that inherit of DatabaseHandlerRepository change the constructor base parameters 2 and 3 from string to SqlCommand. ex :
  ```csharp
          public PlaneHandlerRepository(IConfiguration configuration)
            : base(
            configuration.GetConnectionString("BIADemoDatabase"),
--          "SELECT RowVersion FROM [dbo].[Planes]",
++          new SqlCommand("SELECT RowVersion FROM [dbo].[Planes]"),
--          "SELECT TOP (1) [SiteId] FROM [dbo].[Planes] ORDER BY [RowVersion] DESC",
++          new SqlCommand("SELECT TOP (1) [SiteId] FROM [dbo].[Planes] ORDER BY [RowVersion] DESC"),
            r => PlaneChange(r))
        {
        }
 ```

TODO For ExpressionCollection find generic solution

### BUILD

1. Based on the **BIADemo-V3.9.0 (With BIACompanyFiles)** example, add the **ng lint** task and redo the **ng build prod** task using a **command line** task and no longer an **npm** task.

2. Use Visual Studio 2022, change in task:
- Build solution > Visual Studio Version
Visual Studio 2022

1. Change the path (net6.0 => net 8.0) in the task:
- API Tests > Test files
```
**\$(BuildConfiguration)\net8.0\*$(ProjectName).*.Test.dll
!**\obj\**
```
- Copy Files Presentation Api > Source Folder
```
DotNet/$(CompanyName).$(ProjectName).Presentation.Api/bin/$(BuildConfiguration)/net8.0
```
- Copy Files Worker service > Source Folder
```
DotNet/$(CompanyName).$(ProjectName).WorkerService/bin/$(BuildConfiguration)/net8.
```
- Copy Files DeployDB
```
DotNet/$(CompanyName).$(ProjectName).DeployDB/bin/$(BuildConfiguration)/net8.0
```


### DEPLOY
